## Course Overview

**Duration:** 8-10 hours  
**Level:** Intermediate to Advanced  
**Prerequisites:** Basic understanding of networking protocols (TCP/IP), familiarity with packet analysis tools, foundational cybersecurity knowledge

### Learning Objectives

By the end of this course, you will be able to:
- Identify and analyze malware network behavior patterns
- Detect command-and-control (C2) communications in network traffic
- Recognize data exfiltration techniques and indicators
- Understand malware propagation methods from a network perspective
- Apply forensic analysis techniques to investigate malware incidents
- Utilize industry-standard tools for network-based malware analysis

---

## Module 1: Foundations of Network-Based Malware Analysis

### 1.1 Introduction to Network Forensics in Malware Analysis

Network-based malware analysis examines the communication patterns and network artifacts generated by malicious software. Unlike static or dynamic host-based analysis, this approach focuses on how malware interacts with external resources, making it essential for:

- **Detection:** Identifying infected systems through network anomalies
- **Attribution:** Tracing malware infrastructure and actor patterns
- **Impact Assessment:** Understanding what data was compromised
- **Incident Response:** Containing threats by blocking malicious communications

**Connection to Digital Forensics:** Network analysis provides temporal evidence, chain-of-custody data, and artifacts that survive even after malware removes traces from infected hosts.

### 1.2 Key Network Indicators of Compromise (IOCs)

Network IOCs are observable artifacts that suggest malicious activity:

- **IP Addresses & Domains:** C2 servers, download locations, exfiltration endpoints
- **URL Patterns:** Specific URI structures used by malware families
- **User-Agent Strings:** Uncommon or hardcoded HTTP headers
- **Traffic Volume Anomalies:** Unusual data transfers
- **Protocol Misuse:** Non-standard protocol implementations
- **Beaconing Patterns:** Regular, periodic communications
- **DNS Queries:** Suspicious domain lookups, DGA patterns

**Connection to Core Topic:** These IOCs form the foundation for detecting the three primary network behaviors we'll study: C2 communication, data exfiltration, and propagation.

### 1.3 Essential Tools and Environment Setup

#### Network Capture and Analysis Tools

**Wireshark**
- Industry-standard packet analyzer
- Deep protocol inspection capabilities
- Display filters for targeted analysis
- *Use Case:* Primary tool for examining packet-level details

**tcpdump**
- Command-line packet capture
- Lightweight and scriptable
- Ideal for automated capture scenarios
- *Use Case:* Continuous monitoring and headless environments

**NetworkMiner**
- Network forensic analysis tool
- Automatic artifact extraction
- Host identification and OS fingerprinting
- *Use Case:* Quick triage and file carving from network streams

**Zeek (formerly Bro)**
- Network security monitor
- Generates structured logs from traffic
- Scriptable detection logic
- *Use Case:* Large-scale traffic analysis and detection

**TShark**
- Command-line version of Wireshark
- Programmable output formats
- Batch processing capabilities
- *Use Case:* Automated analysis pipelines

#### Analysis Environment Considerations

- **Isolated Lab Network:** Prevent malware from affecting production systems
- **Traffic Capture Points:** Strategic placement of sensors (SPAN ports, network TAPs)
- **Storage Requirements:** Plan for large PCAP files (can exceed 100GB)
- **Time Synchronization:** Ensure accurate timestamps for correlation

---

## Module 2: Command and Control (C2) Communication Analysis

### 2.1 Understanding C2 Infrastructure

Command and Control infrastructure is the communication channel between infected systems (bots) and attacker-controlled servers. This bidirectional communication allows attackers to:

- Issue commands to compromised systems
- Update malware capabilities
- Coordinate multi-system attacks
- Receive status reports from infected hosts

**Connection to Main Topic:** C2 analysis is fundamental to network-based malware investigation because it reveals the persistent communication mechanism that distinguishes advanced persistent threats (APTs) from simpler malware.

### 2.2 C2 Communication Protocols

#### HTTP/HTTPS C2

**Characteristics:**
- Blends with legitimate web traffic
- Often uses POST requests for commands
- May employ custom encoding schemes
- Cookie-based or parameter-based communication

**Analysis Techniques:**
```
# Wireshark Display Filter for HTTP POST requests
http.request.method == "POST"

# Look for:
- Uncommon User-Agent strings
- Regular intervals between requests (beaconing)
- Base64 or hex-encoded parameters
- Unusual Content-Type headers
```

**Detection Patterns:**
- High-entropy data in URI parameters
- Periodic connections to same endpoint
- Mismatched HTTP headers (e.g., claiming to be a browser but missing typical headers)

#### DNS C2 (DNS Tunneling)

**Characteristics:**
- Exfiltrates data through DNS queries
- Uses subdomains to encode information
- Can bypass many security controls
- Low bandwidth but stealthy

**Analysis Techniques:**
```
# Wireshark Display Filter
dns.qry.name contains "suspicious-domain.com"

# Indicators:
- Unusually long subdomain names
- High volume of queries to single domain
- High entropy in subdomain strings
- TXT record queries with encoded data
```

**Detection Patterns:**
- Queries with excessive subdomain length (>50 characters)
- Regular intervals between queries
- Uncommon record types (TXT, NULL, CNAME abuse)

#### Custom Binary Protocols

**Characteristics:**
- Raw TCP/UDP communication
- Proprietary encoding
- Often uses non-standard ports
- May implement custom encryption

**Analysis Techniques:**
```
# Identify unknown protocols
tcp.port != 80 && tcp.port != 443 && tcp.port != 22

# Analysis steps:
1. Identify packet structure patterns
2. Look for magic bytes or signatures
3. Analyze payload entropy (encryption indicator)
4. Correlate with process execution on host
```

### 2.3 Beaconing Detection

Beaconing refers to regular, periodic communications between malware and C2 servers.

**Statistical Analysis Approach:**

1. **Extract connection timestamps**
2. **Calculate inter-packet intervals**
3. **Identify patterns:**
   - Fixed intervals (e.g., every 60 seconds)
   - Jittered intervals (randomized within range)
   - Sleep/wake patterns

**Tool: RITA (Real Intelligence Threat Analytics)**
- Analyzes Zeek logs for beaconing
- Uses statistical models
- Generates beacon scores

**Manual Analysis with TShark:**
```bash
# Extract HTTP conversations with timestamps
tshark -r capture.pcap -Y "http" -T fields \
  -e frame.time -e ip.src -e ip.dst -e http.host
```

### 2.4 Domain Generation Algorithms (DGA)

DGAs generate pseudo-random domain names for C2 resilience.

**Characteristics:**
- Algorithmically generated domains
- High entropy domain names
- Large volume of NXDOMAIN responses
- Predictable if algorithm is known

**Detection Methods:**

1. **Linguistic Analysis:** Compare against dictionary words
2. **Entropy Calculation:** High randomness in characters
3. **N-gram Analysis:** Character sequence patterns
4. **Machine Learning:** Train classifiers on known DGA families

**Analysis Example:**
```
# Legitimate: amazon.com, google.com, microsoft.com
# DGA: xqpmrzh.com, huifhjwe.net, ajklsdfjkl.org

Entropy calculation for domain:
H = -Σ(p(x) * log2(p(x)))

High entropy (>3.5) suggests DGA
```

### 2.5 C2 Traffic Decryption and Analysis

**SSL/TLS Interception:**
- Requires private keys or MITM positioning
- May not be possible with perfect forward secrecy
- Legal and ethical considerations

**Certificate Analysis:**
- Self-signed certificates
- Unusual certificate authorities
- Certificate reuse across malware campaigns
- Short validity periods

**Metadata Analysis (when decryption unavailable):**
- Connection frequency
- Data volume patterns
- Server geolocation
- Certificate fingerprints

---

## Module 3: Data Exfiltration Detection and Analysis

### 3.1 Understanding Data Exfiltration

Data exfiltration is the unauthorized transfer of sensitive information from a victim system to attacker-controlled infrastructure.

**Connection to Main Topic:** Exfiltration is often the ultimate goal of malware operations. Network analysis is critical because data must traverse the network to reach attackers, leaving forensic evidence regardless of host-based anti-forensics.

### 3.2 Exfiltration Techniques

#### Direct Transfer Methods

**HTTP/HTTPS POST Uploads**
```
Detection Indicators:
- Large POST requests from internal hosts
- Uploads to suspicious domains
- Unusual outbound data volumes
- File extensions in HTTP streams
```

**FTP/SFTP Transfers**
```
# Wireshark filter for FTP data transfers
ftp-data

Analysis steps:
1. Identify FTP STOR commands
2. Extract transferred files
3. Analyze destination servers
4. Correlate with authentication logs
```

#### Steganographic Exfiltration

**DNS Exfiltration:**
- Data encoded in DNS queries
- Small chunks per query
- Reassembled at C2 server

**ICMP Tunneling:**
- Data hidden in ICMP echo requests/replies
- Payload larger than standard ping

**Detection Approach:**
```
# Abnormal ICMP packet sizes
icmp && ip.len > 100

# DNS queries with high entropy
dns.qry.name and (length > 50)
```

#### Protocol Misuse

**HTTP Header Manipulation:**
- Data in User-Agent, Cookie, or custom headers
- Legitimate-looking but data-carrying

**Email Exfiltration:**
- SMTP to external addresses
- Automated email generation
- Attachment-based or body-encoded data

### 3.3 Volume and Anomaly Analysis

**Baseline Establishment:**
1. Normal traffic patterns for organization
2. Expected data volumes per protocol
3. Typical external connections

**Anomaly Detection:**
```
Indicators of exfiltration:
- Spike in outbound traffic from single host
- Large uploads during off-hours
- Connections to geographic anomalies
- Protocol violations (e.g., HTTP on port 443)
```

**NetFlow/IPFIX Analysis:**
- Aggregate flow data
- Identify top talkers
- Detect long-duration connections
- Volume-based anomalies

### 3.4 File Carving from Network Traffic

**Extracting Files with Wireshark:**
1. File → Export Objects → HTTP/SMB/TFTP
2. Identify file transfers in streams
3. Follow TCP stream for manual extraction

**NetworkMiner Automated Extraction:**
- Automatically carves files from PCAP
- Categorizes by file type
- Provides hash values for malware identification

**Manual Carving with tcpflow:**
```bash
tcpflow -r capture.pcap -o output_directory
# Creates separate files for each TCP flow
```

**Hash Analysis:**
```
# Calculate file hashes
md5sum extracted_file.exe
sha256sum extracted_file.exe

# Check against threat intelligence
- VirusTotal
- MISP
- AlienVault OTX
```

### 3.5 Encryption and Obfuscation in Exfiltration

**Identifying Encrypted Exfiltration:**
- High entropy in payload
- Lack of recognizable patterns
- Custom encryption implementations

**Analysis Strategies:**
1. **Metadata Focus:** Size, timing, destination
2. **Correlation:** Match with host-based artifacts
3. **Pattern Recognition:** Repeated encryption schemes
4. **Endpoint Visibility:** Memory analysis for keys

---

## Module 4: Malware Propagation Analysis

### 4.1 Understanding Propagation Mechanisms

Propagation refers to how malware spreads across networks and systems.

**Connection to Main Topic:** Network-based propagation analysis reveals infection vectors, spread velocity, and affected systems scope—critical for containment and remediation in digital forensics investigations.

### 4.2 Network-Based Propagation Methods

#### Network Scanning and Exploitation

**Port Scanning Activity:**
```
# Detect scanning patterns
- Multiple connection attempts to same port across IPs
- SYN scans (SYN packets without completing handshake)
- Sequential IP targeting

Wireshark filter for SYN scans:
tcp.flags.syn==1 && tcp.flags.ack==0
```

**Exploitation Traffic:**
- Shellcode in network packets
- Exploit kit HTTP patterns
- Buffer overflow attempts
- Known CVE exploitation signatures

**Analysis Approach:**
1. Identify source of scanning
2. Determine targeted services
3. Correlate with successful connections
4. Map infection spread timeline

#### Worm Behavior Analysis

**Characteristics:**
- Self-replicating without user interaction
- Rapid network traversal
- Exploitation of vulnerabilities
- May carry additional payloads

**Detection Patterns:**
```
Indicators:
- Identical exploit traffic from multiple sources
- Exponential increase in infected hosts
- Specific port targeting (e.g., WannaCry: SMB port 445)
- Payload signature matching

# Example: Detecting SMB exploitation attempts
smb2.cmd == 0 && tcp.port == 445
```

#### Lateral Movement Detection

**Techniques:**
- SMB file shares
- Remote Desktop Protocol (RDP)
- Windows Management Instrumentation (WMI)
- PowerShell remoting
- Pass-the-hash attacks

**Network Indicators:**
```
# SMB administrative share access
smb2.tree contains "\\C$" or "\\ADMIN$"

# RDP connections
tcp.port == 3389

# WMI over DCOM
tcp.port == 135

Analysis focus:
- Abnormal account usage patterns
- Privilege escalation indicators
- Time-based correlation with other events
```

### 4.3 Protocol-Specific Propagation

#### Email-Based Propagation

**SMTP Analysis:**
```
# Identify mass mailing
smtp.req.command == "RCPT"

Indicators:
- High volume of emails from single source
- Identical subject lines
- Suspicious attachments (executables, scripts)
- Spoofed sender addresses
```

**Attachment Analysis:**
- Extract attachments from PCAP
- Analyze file types and macros
- Check for known malicious hashes
- Sandbox execution for behavior

#### Web-Based Propagation

**Drive-by Download Detection:**
```
Indicators:
- JavaScript obfuscation in HTTP responses
- Exploit kit landing pages
- Redirect chains
- Suspicious MIME types

# Detect JavaScript with high entropy
http.content_type contains "javascript"
```

**Malvertising Patterns:**
- Advertisements serving malware
- Iframe injection
- Redirect to exploit kits

### 4.4 Mapping Infection Chains

**Timeline Reconstruction:**
1. Identify initial infection vector (Patient Zero)
2. Map subsequent infections chronologically
3. Identify propagation method for each spread
4. Visualize infection tree

**Tools and Techniques:**

**Graphical Representation:**
- Use network graphing tools (Gephi, Maltego)
- Map IP relationships
- Timeline visualization

**Log Correlation:**
```
Data sources to correlate:
- Firewall logs
- IDS/IPS alerts
- DNS logs
- Proxy logs
- NetFlow data
- Host-based logs
```

**Attribution and Source Identification:**
- External infection source
- Initial compromise method
- Propagation velocity
- Geographic spread patterns

### 4.5 Botnet Traffic Analysis

**Botnet Communication Patterns:**

**Peer-to-Peer (P2P) Botnets:**
- Distributed C2 architecture
- Node discovery protocols
- Difficult to takedown

**Centralized Botnets:**
- All bots connect to central C2
- Easier to identify and disrupt
- Single point of failure

**Detection Methods:**
```
# Identify potential botnet traffic
- Regular beaconing to same destination
- Binary protocol on unusual ports
- High entropy payloads
- IRC-based C2 (legacy)

# IRC botnet indicators
tcp.port == 6667 && irc
```

---

## Module 5: Advanced Analysis Techniques

### 5.1 Traffic Decryption and MITM Analysis

**SSL/TLS Decryption Approaches:**

**Server-Side Key Access:**
- Requires cooperation or compromise
- Full decryption capability
- Legal considerations critical

**Session Key Logging:**
```
# Browser-based key logging (testing environment)
export SSLKEYLOGFILE=/path/to/keylog.txt

# Load in Wireshark:
Edit → Preferences → Protocols → TLS → 
(Pre)-Master-Secret log filename
```

**Certificate Pinning Bypass:**
- Requires host-level access
- Framework-specific techniques
- Useful for mobile malware analysis

### 5.2 Machine Learning in Network Malware Detection

**Supervised Learning Applications:**

**Classification Models:**
- Benign vs. malicious traffic
- Malware family identification
- C2 protocol classification

**Features for ML:**
```
Network features:
- Packet size distribution
- Inter-arrival times
- Protocol distributions
- Port usage patterns
- Connection duration
- Byte frequency distribution
```

**Unsupervised Learning:**
- Anomaly detection without labeled data
- Clustering similar traffic patterns
- Outlier identification

### 5.3 Threat Intelligence Integration

**IOC Enrichment:**

**Sources:**
- Commercial threat feeds
- Open-source intelligence (OSINT)
- Information Sharing and Analysis Centers (ISACs)
- MISP, AlienVault OTX, VirusTotal

**Integration Workflow:**
```
1. Extract network IOCs from traffic
2. Query threat intelligence platforms
3. Enrich with context (malware family, campaign)
4. Prioritize based on threat score
5. Update detection rules
```

**Automated Detection:**
- SIEM integration
- API-driven lookups
- Real-time alerting

### 5.4 Memory and Network Correlation

**Combined Analysis Approach:**

**Network Captures + Memory Dumps:**
- Decrypt encrypted communications using keys from memory
- Identify malware processes generating traffic
- Reconstruct complete attack timeline

**Correlation Points:**
```
Network → Memory:
- Process ID from network connection
- Memory strings matching network IOCs
- Decryption keys for encrypted traffic

Tools:
- Volatility (memory analysis)
- Wireshark (network analysis)
- Cross-reference with PIDs and sockets
```

### 5.5 Reporting and Documentation

**Forensic Report Structure:**

1. **Executive Summary**
   - High-level findings
   - Impact assessment
   - Recommendations

2. **Technical Analysis**
   - Methodology
   - Timeline of events
   - Detailed findings
   - Evidence artifacts

3. **Network IOCs**
   - IP addresses and domains
   - URLs and file hashes
   - Traffic patterns
   - Signatures

4. **Recommendations**
   - Containment steps
   - Remediation actions
   - Prevention measures
   - Detection improvements

**Chain of Custody:**
- Document all evidence handling
- Maintain hash values of captures
- Time-stamped actions
- Proper evidence storage

---

## Module 6: Practical Application and Case Studies

### 6.1 Case Study: APT-Style C2 Analysis

**Scenario:** A sophisticated attacker has established persistence in your network. Initial triage reveals periodic outbound HTTPS connections to a suspicious domain.

**Analysis Workflow:**

1. **Traffic Isolation**
   ```
   # Filter traffic to suspicious domain
   ip.addr == 203.0.113.42 || dns.qry.name contains "suspicious-domain.com"
   ```

2. **Temporal Analysis**
   - Extract connection timestamps
   - Calculate intervals: 300-second average (5 minutes)
   - Conclusion: Regular beaconing pattern

3. **Certificate Analysis**
   - Self-signed certificate
   - Invalid certificate chain
   - Recent creation date (3 days old)

4. **Endpoint Correlation**
   - Identify source IP: 10.0.1.50
   - Cross-reference with DHCP logs
   - Affected host: WORKSTATION-42

5. **Findings**
   - Confirmed C2 communication
   - Beaconing malware
   - Single infected host identified

### 6.2 Case Study: Ransomware Data Exfiltration

**Scenario:** Ransomware incident with suspected data exfiltration before encryption.

**Analysis Workflow:**

1. **Volume Analysis**
   ```
   # Identify large uploads
   http.request.method == "POST" && http.content_length > 1000000
   ```

2. **Timeline Reconstruction**
   - T-2 hours: Initial compromise
   - T-1 hour: Large POST requests begin
   - T-0: Encryption starts

3. **Data Recovery**
   - Extract HTTP objects
   - Carve files from streams
   - Identify sensitive documents

4. **Attribution**
   - Exfiltration server: 198.51.100.10
   - TOR exit node identified
   - Associated with known ransomware group

5. **Impact Assessment**
   - 2.3 GB exfiltrated
   - Document types: financial, PII
   - Notification requirements triggered

### 6.3 Case Study: Worm Propagation

**Scenario:** Rapid spread of malware across internal network via SMB vulnerability.

**Analysis Workflow:**

1. **Patient Zero Identification**
   ```
   # Find earliest SMB exploitation
   smb2 && (tcp.flags.reset == 1)
   ```

2. **Propagation Mapping**
   - Initial infection: 10.0.1.25 (external source)
   - First internal victim: 10.0.2.10
   - Spread pattern: Sequential IP scanning

3. **Velocity Calculation**
   - 5 systems infected in first 10 minutes
   - Exponential growth pattern
   - 47 total systems compromised

4. **Containment Actions**
   - Block SMB at perimeter
   - Isolate infected segments
   - Patch deployment prioritization

### 6.4 Hands-On Exercise: Analyzing a Sample PCAP

**Exercise Setup:**

You are provided with a PCAP file containing captured malware traffic. Your task is to analyze it and answer the following:

**Required Analysis:**

1. **C2 Identification**
   - What is the C2 server IP/domain?
   - What protocol is used?
   - Is there beaconing? What is the interval?

2. **Exfiltration Detection**
   - Was data exfiltrated?
   - What method was used?
   - Approximate volume transferred?

3. **Propagation Assessment**
   - Did the malware attempt to spread?
   - What propagation method was used?
   - How many systems were targeted?

**Analysis Steps:**

```
Step 1: Open PCAP in Wireshark
Step 2: Protocol hierarchy (Statistics → Protocol Hierarchy)
Step 3: Conversations (Statistics → Conversations)
Step 4: DNS analysis (dns filter)
Step 5: HTTP analysis (http filter)
Step 6: Identify anomalies
Step 7: Extract IOCs
Step 8: Document findings
```

----
## Course Completion

Upon achieving a passing score of 80% or higher, you have demonstrated competency in:

✓ Network-based malware analysis fundamentals  
✓ Command and Control traffic identification and analysis  
✓ Data exfiltration detection techniques  
✓ Malware propagation pattern recognition  
✓ Advanced analysis methodologies and tools  
✓ Practical application of digital forensic principles  

**Recommended Next Steps:**
1. Practice with real malware PCAPs from malware-traffic-analysis.net
2. Pursue GIAC Network Forensic Analyst (GNFA) certification
3. Engage with the DFIR community through forums and conferences
4. Build a personal lab environment for continued learning
5. Stay current with emerging malware families and techniques

